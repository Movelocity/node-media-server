<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Stream Test Player</title>
  
  <link href="./lib/font-awesome.min.css" rel="stylesheet">
  <style>
    /* è‡ªå®šä¹‰åŠ¨ç”» - Tailwindä¸æ”¯æŒçš„ç‰¹æ®Šæ•ˆæœ */
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    .fa-spin {
      animation: spin 1s linear infinite;
    }

    /* å…¨å±æŒ‰é’®hoveræ•ˆæœ */
    .video-container:hover .fullscreen-btn {
      opacity: 1;
    }

    /* ä¾§è¾¹å¯¼èˆªæ è¿‡æ¸¡åŠ¨ç”» */
    .sidebar {
      transition: width 0.3s ease;
    }

    /* å¯¼èˆªé¡¹æ¿€æ´»çŠ¶æ€ */
    .nav-item.active {
      background-color: #e5e7eb;
      border-left: 4px solid #3b82f6;
    }

    .nav-item:hover {
      background-color: #f3f4f6;
    }

    /* æŠ˜å æ—¶çš„æç¤º */
    .sidebar.collapsed .nav-text {
      display: none;
    }

    .sidebar.collapsed .nav-item {
      justify-content: center;
    }

    button {
      cursor: pointer;
    }
  </style>
  <script src="./lib/flv.min.js"></script>
  <script src="./lib/tailwind.min.js"></script>
</head>

<body class="font-sans bg-gray-100 h-screen text-gray-800 flex">
  <!-- å·¦ä¾§å¯¼èˆªæ  -->
  <aside id="sidebar" class="sidebar bg-white border-r border-gray-200 flex flex-col" style="width: 240px;">
    <!-- LogoåŒºåŸŸ -->
    <div class="p-4 border-b border-gray-200 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="fas fa-video text-blue-600 text-xl"></i>
        <span class="nav-text font-bold text-gray-800 text-lg">æµåª’ä½“ä¸­å¿ƒ</span>
      </div>
      <button id="sidebarToggle" class="text-gray-500 hover:text-gray-700 p-1">
        <i class="fas fa-bars"></i>
      </button>
    </div>

    <!-- å¯¼èˆªèœå• -->
    <nav class="flex-1 p-3">
      <div class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1" data-page="index.html">
        <i class="fas fa-play-circle text-lg text-gray-600"></i>
        <span class="nav-text text-gray-700 font-medium">æ’­æ”¾å™¨</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1" data-page="config.html">
        <i class="fas fa-cog text-lg text-gray-600"></i>
        <span class="nav-text text-gray-700 font-medium">é…ç½®ç®¡ç†</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1" data-page="monitor.html">
        <i class="fas fa-chart-line text-lg text-gray-600"></i>
        <span class="nav-text text-gray-700 font-medium">æ€§èƒ½ç›‘æ§</span>
      </div>
      
      <!-- åˆ†éš”çº¿ -->
      <div class="my-3 border-t border-gray-200"></div>
      
      <!-- å¿«æ·æ“ä½œ -->
      <div class="px-2 mb-2">
        <div class="nav-text text-xs text-gray-500 font-semibold uppercase tracking-wider px-2">å¿«æ·æ“ä½œ</div>
      </div>
      <div id="quickPlayBtn" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1">
        <i class="fas fa-play text-lg text-green-600"></i>
        <span class="nav-text text-gray-700 font-medium">å¼€å§‹æ’­æ”¾</span>
      </div>
      <div id="quickStopBtn" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1 opacity-50 pointer-events-none">
        <i class="fas fa-stop text-lg text-red-600"></i>
        <span class="nav-text text-gray-700 font-medium">åœæ­¢æ’­æ”¾</span>
      </div>
    </nav>

    <!-- åº•éƒ¨çŠ¶æ€ -->
    <div class="p-4 border-t border-gray-200">
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-gray-400" id="globalStatus"></div>
        <span class="nav-text text-sm text-gray-600">ç³»ç»Ÿå°±ç»ª</span>
      </div>
    </div>
  </aside>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <main class="flex-1 overflow-auto">
    <!-- é¡¶éƒ¨é¢åŒ…å±‘å¯¼èˆª -->
    <div class="bg-white border-b border-gray-200 px-6 py-4">
      <div class="flex items-center gap-2 text-sm text-gray-600">
        <i class="fas fa-home"></i>
        <span class="text-gray-400">/</span>
        <span class="font-medium text-gray-800">æ’­æ”¾å™¨</span>
      </div>
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="p-6">
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-6">
        <!-- Video Section -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
          <!-- Video Container -->
          <div class="video-container relative bg-black rounded-lg overflow-hidden mb-5">
            <video id="videoElement" controls muted class="w-full h-auto min-h-[400px] block"></video>
            
            <!-- Video Overlay -->
            <div class="absolute inset-0 bg-black/80 flex items-center justify-center flex-col text-white transition-opacity duration-300 cursor-pointer" id="videoOverlay">
              <div class="loading-spinner hidden" id="loadingSpinner"></div>
              <i class="fas fa-play-circle text-6xl mb-5 opacity-70" id="playIcon"></i>
              <h3 class="text-xl font-semibold" id="overlayText">ç‚¹å‡»å¼€å§‹æ’­æ”¾</h3>
              <p class="text-sm opacity-80 mt-2" id="overlaySubtext">å‡†å¤‡è¿æ¥ç›´æ’­æµ</p>
            </div>
            
            <!-- Fullscreen Button -->
            <button class="fullscreen-btn absolute top-2.5 right-2.5 bg-black/50 text-white border-0 px-2 py-1.5 rounded cursor-pointer opacity-0 transition-opacity duration-300" id="fullscreenBtn">
              <i class="fas fa-expand"></i>
            </button>
          </div>

          <!-- Controls -->
          <div class="flex gap-2 justify-between items-center mb-4">
            <div class="flex gap-2">
              <button id="playButton" class="px-4 py-2.5 border-0 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 flex items-center gap-2 no-underline text-white bg-green-600 hover:bg-green-700">
                <i class="fas fa-play"></i> å¼€å§‹æ’­æ”¾
              </button>
              <button id="stopButton" class="px-4 py-2.5 border-0 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 flex items-center gap-2 no-underline text-white bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-stop"></i> åœæ­¢
              </button>
              <button id="refreshButton" class="px-4 py-2.5 border-0 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 flex items-center gap-2 no-underline text-white bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-sync"></i> é‡æ–°åŒæ­¥
              </button>
              <button id="screenshotButton" class="px-4 py-2.5 border-0 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 flex items-center gap-2 no-underline text-white bg-orange-600 hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-camera"></i> æˆªå›¾
              </button>
            </div>

            <!-- Volume Control -->
            <div class="flex items-center gap-2.5">
              <i class="fas fa-volume-down text-gray-500"></i>
              <input type="range" id="volumeSlider" class="flex-1 h-2 rounded-lg appearance-none bg-gray-200 outline-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-blue-600 [&::-webkit-slider-thumb]:cursor-pointer" min="0" max="1" step="0.1" value="0.5">
              <i class="fas fa-volume-up text-gray-500"></i>
              <span id="volumeDisplay" class="text-sm font-medium text-gray-700 min-w-[45px] text-center">50%</span>
            </div>
          </div>


          <!-- Quality Selector -->
          <div class="flex gap-2 items-center">
            <span class="text-sm text-gray-600 font-medium">ç”»è´¨:</span>
            <button class="quality-btn px-3 py-1.5 border border-gray-300 bg-white rounded-md cursor-pointer text-sm transition-all duration-200 hover:bg-gray-50 active:bg-blue-600 active:text-white active:border-blue-600" data-quality="auto">è‡ªåŠ¨</button>
            <button class="quality-btn px-3 py-1.5 border border-gray-300 bg-white rounded-md cursor-pointer text-sm transition-all duration-200 hover:bg-gray-50" data-quality="high">é«˜æ¸…</button>
            <button class="quality-btn px-3 py-1.5 border border-gray-300 bg-white rounded-md cursor-pointer text-sm transition-all duration-200 hover:bg-gray-50" data-quality="medium">æ ‡æ¸…</button>
            <button class="quality-btn px-3 py-1.5 border border-gray-300 bg-white rounded-md cursor-pointer text-sm transition-all duration-200 hover:bg-gray-50" data-quality="low">æµç•…</button>
          </div>
        </div>

        <!-- Control Panel -->
        <div class="space-y-3">
          <!-- Stream Config -->
          <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between gap-2">
              <h3 class="text-base text-gray-800 flex items-center gap-2 font-semibold">
                <i class="fas fa-cog text-blue-600"></i> æµé…ç½®
              </h3>
              <div class="flex items-center gap-2 px-3 py-1 rounded-lg font-medium bg-gray-50 text-gray-700 border border-gray-200" id="connectionStatus">
                <i class="fas fa-circle text-gray-400"></i>
                <span>æœªè¿æ¥</span>
              </div>
            </div>
            <div class="mb-3">
              <label for="streamSelect" class="block mb-1.5 font-medium text-gray-600 text-sm">é€‰æ‹©é¢‘é“:</label>
              <div class="flex gap-2">
                <select id="streamSelect" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors duration-200 focus:outline-none focus:border-blue-500 cursor-pointer">
                  <option value="">æ­£åœ¨åŠ è½½...</option>
                </select>
                <button id="refreshStreamsBtn" class="px-3 py-1 border-1 border-gray-300 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 flex items-center gap-2 text-blue-500 hover:text-blue-600" title="åˆ·æ–°é¢‘é“åˆ—è¡¨">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
              <div id="streamInfo" class="mt-2 text-xs text-gray-500 hidden"></div>
            </div>
            <div class="mb-0">
              <label for="protocolSelect" class="block mb-1.5 font-medium text-gray-600 text-sm">åè®®:</label>
              <select id="protocolSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors duration-200 focus:outline-none focus:border-blue-500 cursor-pointer">
                <option value="flv">FLV</option>
                <option value="hls">HLS</option>
                <option value="rtmp">RTMP</option>
              </select>
            </div>
          </div>

          <!-- Debug Log -->
          <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">
            <h3 class="text-base text-gray-800 mb-3 flex items-center gap-2 font-semibold">
              <i class="fas fa-terminal text-blue-600"></i> è°ƒè¯•æ—¥å¿—
            </h3>
            <div class="bg-gray-50 border border-gray-200 rounded-lg h-[180px] overflow-y-auto px-3 py-2 font-mono text-xs" id="logContainer">
              <div class="mb-1 leading-relaxed">
                <span class="text-gray-500 mr-2">00:00:00</span>
                <span class="text-blue-600">ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ</span>
              </div>
            </div>
            <button class="mt-3 w-full px-4 py-2.5 border-0 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 text-white bg-gray-600 hover:bg-gray-700" id="clearLogButton">
              <i class="fas fa-trash"></i>
              æ¸…ç©ºæ—¥å¿—
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ä¾§è¾¹æ æŠ˜å åŠŸèƒ½
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar.style.width === '240px') {
        sidebar.style.width = '80px';
        sidebar.classList.add('collapsed');
      } else {
        sidebar.style.width = '240px';
        sidebar.classList.remove('collapsed');
      }
    });

    // å¯¼èˆªé¡¹ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', function() {
        const page = this.dataset.page;
        window.location.href = page;
      });
    });

    class LiveStreamPlayer {
      constructor() {
        this.player = null;
        this.isPlaying = false;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.streamRefreshInterval = null;

        this.initializeElements();
        this.bindEvents();
        this.log('info', 'æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
        
        // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°æµåˆ—è¡¨
        this.streamRefreshInterval = setInterval(() => {
          this.loadAvailableStreams();
        }, 10000);
      }

      initializeElements() {
        this.elements = {
          video: document.getElementById('videoElement'),
          playButton: document.getElementById('playButton'),
          stopButton: document.getElementById('stopButton'),
          refreshButton: document.getElementById('refreshButton'),
          screenshotButton: document.getElementById('screenshotButton'),
          fullscreenBtn: document.getElementById('fullscreenBtn'),
          streamSelect: document.getElementById('streamSelect'),
          streamInfo: document.getElementById('streamInfo'),
          refreshStreamsBtn: document.getElementById('refreshStreamsBtn'),
          protocolSelect: document.getElementById('protocolSelect'),
          connectionStatus: document.getElementById('connectionStatus'),
          videoOverlay: document.getElementById('videoOverlay'),
          loadingSpinner: document.getElementById('loadingSpinner'),
          playIcon: document.getElementById('playIcon'),
          overlayText: document.getElementById('overlayText'),
          overlaySubtext: document.getElementById('overlaySubtext'),
          volumeSlider: document.getElementById('volumeSlider'),
          volumeDisplay: document.getElementById('volumeDisplay'),
          logContainer: document.getElementById('logContainer'),
          clearLogButton: document.getElementById('clearLogButton'),
          quickPlayBtn: document.getElementById('quickPlayBtn'),
          quickStopBtn: document.getElementById('quickStopBtn'),
          globalStatus: document.getElementById('globalStatus')
        };
        
        // åˆå§‹åŒ–æµåˆ—è¡¨
        this.loadAvailableStreams();
      }

      bindEvents() {
        this.elements.playButton.addEventListener('click', () => this.startStream());
        this.elements.videoOverlay.addEventListener('click', () => this.startStream());
        this.elements.stopButton.addEventListener('click', () => this.stopStream());
        this.elements.refreshButton.addEventListener('click', () => this.refreshStream());
        this.elements.screenshotButton.addEventListener('click', () => this.takeScreenshot());
        this.elements.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
        this.elements.clearLogButton.addEventListener('click', () => this.clearLog());
        
        // å¿«æ·æŒ‰é’®
        this.elements.quickPlayBtn.addEventListener('click', () => this.startStream());
        this.elements.quickStopBtn.addEventListener('click', () => this.stopStream());

        this.elements.volumeSlider.addEventListener('input', (e) => {
          const volume = parseFloat(e.target.value);
          this.elements.video.volume = volume;
          this.elements.volumeDisplay.textContent = Math.round(volume * 100) + '%';
        });

        // æµé€‰æ‹©å˜åŒ–äº‹ä»¶
        this.elements.streamSelect.addEventListener('change', () => {
          this.updateStreamInfo();
        });

        // åˆ·æ–°æµåˆ—è¡¨æŒ‰é’®
        this.elements.refreshStreamsBtn.addEventListener('click', () => {
          this.loadAvailableStreams();
        });

        // è´¨é‡é€‰æ‹©å™¨
        document.querySelectorAll('.quality-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.quality-btn').forEach(b => {
              b.classList.remove('active', 'bg-blue-600', 'text-white', 'border-blue-600');
              b.classList.add('bg-white');
            });
            e.target.classList.add('active', 'bg-blue-600', 'text-white', 'border-blue-600');
            e.target.classList.remove('bg-white');
            this.log('info', `åˆ‡æ¢ç”»è´¨: ${e.target.dataset.quality}`);
          });
        });


        // è§†é¢‘äº‹ä»¶
        this.elements.video.addEventListener('loadstart', () => this.onVideoLoadStart());
        this.elements.video.addEventListener('canplay', () => this.onVideoCanPlay());
        this.elements.video.addEventListener('error', (e) => this.onVideoError(e));
        this.elements.video.addEventListener('play', () => this.onVideoPlay());
        this.elements.video.addEventListener('pause', () => this.onVideoPause());

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
          if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            this.togglePlayPause();
          } else if (e.code === 'KeyF') {
            e.preventDefault();
            this.toggleFullscreen();
          }
        });
      }

      getStreamUrl() {
        const selectedOption = this.elements.streamSelect.selectedOptions[0];
        if (!selectedOption || !selectedOption.value) {
          this.log('error', 'è¯·é€‰æ‹©ä¸€ä¸ªé¢‘é“');
          return null;
        }
        
        const streamPath = selectedOption.value; // ä¾‹å¦‚ "/live/yard-1"
        const streamName = selectedOption.dataset.streamName || 'demo';
        const protocol = this.elements.protocolSelect.value;

        switch (protocol) {
          case 'flv':
            return `${streamPath}.flv`;
          case 'hls':
            return `${streamPath}/index.m3u8`;
          case 'rtmp':
            return `rtmp://localhost${streamPath}`;
          default:
            return `${streamPath}.flv`;
        }
      }

      async startStream() {
        try {
          this.updateConnectionStatus('connecting');
          this.showLoading(true);
          this.log('info', 'å¼€å§‹è¿æ¥ç›´æ’­æµ...');

          if (!flvjs.isSupported()) {
            throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ FLV æ’­æ”¾');
          }

          if (this.player) {
            this.destroyPlayer();
          }

          const streamUrl = this.getStreamUrl();
          if (!streamUrl) {
            throw new Error('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„é¢‘é“');
          }
          this.log('info', `è¿æ¥åœ°å€: ${streamUrl}`);

          this.player = flvjs.createPlayer({
            type: 'flv',
            url: streamUrl,
            isLive: true,
            hasAudio: true,
            hasVideo: true,
            enableStashBuffer: false,
            stashInitialSize: 128,
            enableWorker: true,
            lazyLoad: false,
            seekType: 'range',
            reuseRedirectedURL: true,
            autoCleanupSourceBuffer: true
          });

          this.player.attachMediaElement(this.elements.video);

          // æ’­æ”¾å™¨äº‹ä»¶ç›‘å¬
          this.player.on(flvjs.Events.LOADING_COMPLETE, () => {
            this.log('success', 'æµåŠ è½½å®Œæˆ');
          });

          this.player.on(flvjs.Events.RECOVERED_EARLY_EOF, () => {
            this.log('warning', 'æ£€æµ‹åˆ°æµä¸­æ–­ï¼Œæ­£åœ¨å°è¯•æ¢å¤...');
          });

          this.player.on(flvjs.Events.ERROR, (errorType, errorDetail) => {
            this.log('error', `æ’­æ”¾å™¨é”™è¯¯: ${errorType} - ${errorDetail}`);
            this.handlePlayerError(errorType, errorDetail);
          });

          await this.player.load();
          await this.elements.video.play();

          this.isPlaying = true;
          this.reconnectAttempts = 0;
          this.updateConnectionStatus('connected');
          this.updateControls();
          this.showLoading(false);
          this.hideOverlay();

          this.log('success', 'å¼€å§‹æ’­æ”¾ç›´æ’­æµ');

        } catch (error) {
          this.log('error', `è¿æ¥å¤±è´¥: ${error.message}`);
          this.updateConnectionStatus('error');
          this.showLoading(false);
          this.showOverlay('è¿æ¥å¤±è´¥', error.message);

          // è‡ªåŠ¨é‡è¿
          if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            this.log('info', `${3}ç§’åå°è¯•ç¬¬${this.reconnectAttempts}æ¬¡é‡è¿...`);
            setTimeout(() => this.startStream(), 3000);
          }
        }
      }

      stopStream() {
        try {
          if (this.player) {
            this.elements.video.pause();
            this.destroyPlayer();
          }

          this.isPlaying = false;
          this.updateConnectionStatus('disconnected');
          this.updateControls();
          this.showOverlay('å·²åœæ­¢æ’­æ”¾', 'ç‚¹å‡»å¼€å§‹æ’­æ”¾æŒ‰é’®é‡æ–°è¿æ¥');
          this.log('info', 'åœæ­¢æ’­æ”¾');
        } catch (error) {
          this.log('error', `åœæ­¢æ’­æ”¾æ—¶å‡ºé”™: ${error.message}`);
        }
      }

      async refreshStream() {
        this.log('info', 'åˆ·æ–°ç›´æ’­æµ...');
        if (this.isPlaying) {
          this.stopStream();
          setTimeout(() => this.startStream(), 1000);
        } else {
          this.startStream();
        }
      }

      destroyPlayer() {
        if (this.player) {
          try {
            this.player.pause();
            this.player.unload();
            this.player.detachMediaElement();
            this.player.destroy();
            this.player = null;
          } catch (error) {
            this.log('error', `é”€æ¯æ’­æ”¾å™¨æ—¶å‡ºé”™: ${error.message}`);
          }
        }
      }

      handlePlayerError(errorType, errorDetail) {
        this.updateConnectionStatus('error');

        // æ ¹æ®é”™è¯¯ç±»å‹å¤„ç†
        if (errorType === flvjs.ErrorTypes.NETWORK_ERROR) {
          this.log('warning', 'ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡è¿...');
          if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            setTimeout(() => this.startStream(), 2000);
          }
        } else if (errorType === flvjs.ErrorTypes.MEDIA_ERROR) {
          this.log('error', 'åª’ä½“è§£ç é”™è¯¯');
          this.showOverlay('åª’ä½“é”™è¯¯', 'æµæ ¼å¼ä¸æ”¯æŒæˆ–å·²æŸå');
        }
      }

      updateConnectionStatus(status) {
        const statusElement = this.elements.connectionStatus;
        const globalStatus = this.elements.globalStatus;
        
        // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
        statusElement.className = 'flex items-center gap-2 px-3 py-1 rounded-lg font-medium border';

        switch (status) {
          case 'connected':
            statusElement.classList.add('bg-green-50', 'text-green-800', 'border-green-200');
            statusElement.innerHTML = '<i class="fas fa-circle text-green-500"></i><span>å·²è¿æ¥</span>';
            globalStatus.className = 'w-2 h-2 rounded-full bg-green-500';
            break;
          case 'connecting':
            statusElement.classList.add('bg-orange-50', 'text-orange-700', 'border-orange-200');
            statusElement.innerHTML = '<i class="fas fa-circle text-orange-500"></i><span>è¿æ¥ä¸­...</span>';
            globalStatus.className = 'w-2 h-2 rounded-full bg-orange-500';
            break;
          case 'error':
            statusElement.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
            statusElement.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i><span>è¿æ¥é”™è¯¯</span>';
            globalStatus.className = 'w-2 h-2 rounded-full bg-red-500';
            break;
          default:
            statusElement.classList.add('bg-gray-50', 'text-gray-700', 'border-gray-200');
            statusElement.innerHTML = '<i class="fas fa-circle text-gray-400"></i><span>æœªè¿æ¥</span>';
            globalStatus.className = 'w-2 h-2 rounded-full bg-gray-400';
        }
      }

      updateControls() {
        this.elements.playButton.disabled = this.isPlaying;
        this.elements.stopButton.disabled = !this.isPlaying;
        this.elements.screenshotButton.disabled = !this.isPlaying;
        
        // æ›´æ–°å¿«æ·æŒ‰é’®çŠ¶æ€
        if (this.isPlaying) {
          this.elements.quickPlayBtn.classList.add('opacity-50', 'pointer-events-none');
          this.elements.quickStopBtn.classList.remove('opacity-50', 'pointer-events-none');
        } else {
          this.elements.quickPlayBtn.classList.remove('opacity-50', 'pointer-events-none');
          this.elements.quickStopBtn.classList.add('opacity-50', 'pointer-events-none');
        }
      }

      showLoading(show) {
        this.elements.loadingSpinner.style.display = show ? 'block' : 'none';
        this.elements.playIcon.style.display = show ? 'none' : 'block';
      }

      showOverlay(title, subtitle = '') {
        this.elements.overlayText.textContent = title;
        this.elements.overlaySubtext.textContent = subtitle;
        this.elements.videoOverlay.classList.remove('opacity-0', 'pointer-events-none');
      }

      hideOverlay() {
        this.elements.videoOverlay.classList.add('opacity-0', 'pointer-events-none');
      }

      togglePlayPause() {
        if (this.isPlaying) {
          this.stopStream();
        } else {
          this.startStream();
        }
      }

      toggleFullscreen() {
        const container = this.elements.video.parentElement;
        if (!document.fullscreenElement) {
          container.requestFullscreen();
          this.elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
          document.exitFullscreen();
          this.elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        }
      }

      takeScreenshot() {
        try {
          const canvas = document.createElement('canvas');
          const video = this.elements.video;

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);

          const link = document.createElement('a');
          link.download = `screenshot_${new Date().getTime()}.png`;
          link.href = canvas.toDataURL();
          link.click();

          this.log('success', 'æˆªå›¾å·²ä¿å­˜');
        } catch (error) {
          this.log('error', `æˆªå›¾å¤±è´¥: ${error.message}`);
        }
      }

      /**
       * åŠ è½½å¯ç”¨çš„æµåˆ—è¡¨
       */
      async loadAvailableStreams() {
        try {
          // æ·»åŠ åˆ·æ–°æŒ‰é’®çš„æ—‹è½¬åŠ¨ç”»
          const refreshIcon = this.elements.refreshStreamsBtn.querySelector('i');
          refreshIcon.classList.add('fa-spin');
          
          const response = await fetch('/api/statistics/streams');
          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.message || 'è·å–é¢‘é“åˆ—è¡¨å¤±è´¥');
          }
          
          const streams = result.data || [];
          const currentSelection = this.elements.streamSelect.value;
          
          this.renderStreamOptions(streams);
          
          // å°è¯•ä¿æŒä¹‹å‰çš„é€‰æ‹©
          if (currentSelection && this.elements.streamSelect.querySelector(`option[value="${currentSelection}"]`)) {
            this.elements.streamSelect.value = currentSelection;
            this.updateStreamInfo();
          }
          
          this.log('success', `å·²åŠ è½½ ${streams.length} ä¸ªé¢‘é“`);
          
          // ç§»é™¤æ—‹è½¬åŠ¨ç”»
          setTimeout(() => {
            refreshIcon.classList.remove('fa-spin');
          }, 500);
        } catch (error) {
          this.log('error', `åŠ è½½é¢‘é“åˆ—è¡¨å¤±è´¥: ${error.message}`);
          this.elements.streamSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</option>';
          
          // ç§»é™¤æ—‹è½¬åŠ¨ç”»
          const refreshIcon = this.elements.refreshStreamsBtn.querySelector('i');
          refreshIcon.classList.remove('fa-spin');
        }
      }

      /**
       * æ¸²æŸ“æµé€‰é¡¹
       */
      renderStreamOptions(streams) {
        if (streams.length === 0) {
          this.elements.streamSelect.innerHTML = '<option value="">æš‚æ— å¯ç”¨é¢‘é“</option>';
          return;
        }
        
        // æŒ‰çŠ¶æ€æ’åºï¼šåœ¨çº¿çš„åœ¨å‰
        streams.sort((a, b) => {
          if (a.status === 'online' && b.status !== 'online') return -1;
          if (a.status !== 'online' && b.status === 'online') return 1;
          return a.name.localeCompare(b.name);
        });
        
        this.elements.streamSelect.innerHTML = streams.map(stream => {
          const statusIcon = stream.status === 'online' ? 'ğŸŸ¢' : 'âš«';
          const disabled = stream.status !== 'online' ? 'disabled' : '';
          const label = `${statusIcon} ${stream.name} ${stream.status === 'online' ? `` : '(ç¦»çº¿)'}`;
          
          return `<option value="${stream.id}" 
                         data-stream-name="${stream.name}"
                         data-status="${stream.status}"
                         data-viewers="${stream.viewers}"
                         data-bitrate="${stream.bitrate}"
                         data-uptime="${stream.uptime}"
                         ${disabled}>${label}</option>`;
        }).join('');
        
        // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªåœ¨çº¿çš„æµ
        const firstOnline = streams.find(s => s.status === 'online');
        if (firstOnline) {
          this.elements.streamSelect.value = firstOnline.id;
          this.updateStreamInfo();
        }
      }

      /**
       * æ›´æ–°æµä¿¡æ¯æ˜¾ç¤º
       */
      updateStreamInfo() {
        const selectedOption = this.elements.streamSelect.selectedOptions[0];
        if (!selectedOption || !selectedOption.value) {
          this.elements.streamInfo.classList.add('hidden');
          return;
        }
        
        const status = selectedOption.dataset.status;
        const viewers = selectedOption.dataset.viewers;
        const bitrate = selectedOption.dataset.bitrate;
        const uptime = selectedOption.dataset.uptime;
        
        if (status === 'online') {
          this.elements.streamInfo.innerHTML = `
            <i class="fas fa-info-circle"></i> 
            ğŸ“¡ ${bitrate} | ğŸ‘¥ ${viewers} clients | â±ï¸ ${uptime}
          `;
          this.elements.streamInfo.classList.remove('hidden');
        } else {
          this.elements.streamInfo.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> 
            è¯¥é¢‘é“å½“å‰ç¦»çº¿
          `;
          this.elements.streamInfo.classList.remove('hidden');
        }
      }

      log(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = 'mb-1 leading-relaxed';
        
        const colorClass = {
          'info': 'text-blue-600',
          'success': 'text-green-600',
          'warning': 'text-orange-600',
          'error': 'text-red-600'
        }[type] || 'text-gray-600';
        
        logEntry.innerHTML = `
                    <span class="text-gray-500 mr-2">${timestamp}</span>
                    <span class="${colorClass}">${message}</span>
                `;

        this.elements.logContainer.appendChild(logEntry);
        this.elements.logContainer.scrollTop = this.elements.logContainer.scrollHeight;

        // é™åˆ¶æ—¥å¿—æ¡æ•°
        const logs = this.elements.logContainer.children;
        if (logs.length > 100) {
          this.elements.logContainer.removeChild(logs[0]);
        }
      }

      clearLog() {
        this.elements.logContainer.innerHTML = '';
        this.log('info', 'æ—¥å¿—å·²æ¸…ç©º');
      }

      // è§†é¢‘äº‹ä»¶å¤„ç†
      onVideoLoadStart() {
        this.log('info', 'å¼€å§‹åŠ è½½è§†é¢‘');
      }

      onVideoCanPlay() {
        this.log('success', 'è§†é¢‘å¯ä»¥æ’­æ”¾');
      }

      onVideoError(event) {
        const error = event.target.error;
        this.log('error', `è§†é¢‘é”™è¯¯: ${error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);
      }

      onVideoPlay() {
        this.log('success', 'è§†é¢‘å¼€å§‹æ’­æ”¾');
      }

      onVideoPause() {
        this.log('info', 'è§†é¢‘æš‚åœ');
      }
    }

    // åˆå§‹åŒ–æ’­æ”¾å™¨
    document.addEventListener('DOMContentLoaded', () => {
      window.streamPlayer = new LiveStreamPlayer();
    });
  </script>
</body>

</html>