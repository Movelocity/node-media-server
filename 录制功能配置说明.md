# Node Media Server 录制功能配置说明

## 新增功能特性

### 1. 按流名称分文件夹录制
- 自动根据流路径创建目录结构：`recordPath/app/streamName/`
- 每个流独立管理录制文件

### 2. 30分钟分片录制
- 支持自定义分片时长（默认30分钟 = 1800秒）
- 自动轮转文件，避免单个文件过大
- 文件命名格式：`YYYYMMDDHHMMSS_segment_001.flv`

### 3. 录制会话管理
- 支持手动停止录制
- 查询活跃录制会话
- 防止重复录制

## 配置说明

### 基础配置
```javascript
const config = {
  record: {
    path: "./records",           // 录制文件根目录
    segmentDuration: 1800        // 分片时长(秒)，默认30分钟
  }
};
```

### 完整配置示例
```javascript
const NodeMediaServer = require('./src/index');

const config = {
  rtmp: {
    port: 1935,
    chunk_size: 60000,
    gop_cache: true,
    ping: 30,
    ping_timeout: 60
  },
  http: {
    port: 8000,
    allow_origin: '*'
  },
  record: {
    path: './records',           // 录制根目录
    segmentDuration: 1800        // 30分钟分片
  }
};

const nms = new NodeMediaServer(config);
nms.run();
```

## 目录结构示例

推流 `rtmp://localhost/live/stream1` 时，录制文件结构：
```
records/
└── live/
    └── stream1/
        ├── 20241201143022_segment_001.flv
        ├── 20241201173022_segment_002.flv
        └── 20241201203022_segment_003.flv
```

推流 `rtmp://localhost/app/test` 时，录制文件结构：
```
records/
└── app/
    └── test/
        ├── 20241201144500_segment_001.flv
        └── 20241201174500_segment_002.flv
```

## 文件命名规则

- **格式**: `YYYYMMDDHHMMSS_segment_NNN.flv`
- **说明**:
  - `YYYYMMDDHHMMSS`: 分片开始时间
  - `segment`: 固定标识
  - `NNN`: 分片序号（001, 002, 003...）
  - `.flv`: FLV 格式

## API 扩展

### 手动停止录制
```javascript
// 停止指定流的录制
const success = nms.recordServer.stopRecord('/live/stream1');
console.log('停止录制:', success);
```

### 查询活跃录制
```javascript
// 获取所有正在录制的流
const activeRecords = nms.recordServer.getActiveRecords();
console.log('活跃录制:', activeRecords);
```

### 停止所有录制
```javascript
// 停止所有录制
nms.recordServer.stopAllRecords();
```

## 事件监听

### 录制开始事件
```javascript
nms.on('postPublish', (session) => {
  console.log(`开始录制流: ${session.streamPath}`);
});
```

### 录制结束事件
```javascript
nms.on('donePublish', (session) => {
  console.log(`停止录制流: ${session.streamPath}`);
});
```

### 录制完成事件
```javascript
nms.on('doneRecord', (session) => {
  console.log(`录制完成: ${session.streamPath}`);
});
```

## 高级配置

### 自定义分片时长
```javascript
const config = {
  record: {
    path: './records',
    segmentDuration: 3600        // 1小时分片
  }
};
```

### 不同时长配置对照表
| 时长 | 秒数 | 用途 |
|------|------|------|
| 15分钟 | 900 | 短时录制 |
| 30分钟 | 1800 | 标准配置 |
| 1小时 | 3600 | 长时录制 |
| 2小时 | 7200 | 超长录制 |

## 注意事项

### 1. 存储空间
- 30分钟 1080p 视频约占用 200-500MB
- 确保有足够的磁盘空间
- 建议定期清理过期录制文件

### 2. 性能影响
- 录制会增加磁盘 I/O 负载
- 多流同时录制时监控系统性能
- 建议使用 SSD 存储提升性能

### 3. 文件管理
- 分片文件可独立播放
- 可通过脚本合并分片文件
- 建议实现自动清理机制

## 故障排查

### 权限问题
```bash
# 确保录制目录有写权限
chmod 755 ./records
```

### 磁盘空间
```bash
# 检查磁盘空间
df -h
```

### 日志查看
```javascript
// 查看录制相关日志
logger.level = "debug";
```

## 扩展建议

### 1. 自动清理
```javascript
// 清理7天前的录制文件
const cleanupOldRecords = (recordPath, days = 7) => {
  // 实现清理逻辑
};
```

### 2. 文件合并
```javascript
// 合并分片文件为完整视频
const mergeSegments = (streamPath) => {
  // 使用 FFmpeg 合并分片
};
```

### 3. 云存储上传
```javascript
// 上传到云存储
const uploadToCloud = (filePath) => {
  // 实现云存储上传
};
``` 