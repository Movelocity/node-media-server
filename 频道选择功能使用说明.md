# 频道选择功能使用说明

## 📝 功能概述

已成功将 `static/index.html` 中的流配置输入框改为下拉选择框，通过 `/api/statistics/streams` API 动态获取可用频道列表。

## ✨ 新增功能

### 1. 动态频道选择器
- **下拉选择框**：替代原来的文本输入框
- **实时状态显示**：
  - 🟢 在线频道（可选择）
  - ⚫ 离线频道（禁用）
- **观看人数**：显示每个在线频道的观看人数

### 2. 刷新按钮
- 位于下拉框右侧的蓝色刷新按钮
- 点击后带有旋转动画
- 手动刷新频道列表

### 3. 频道信息展示
选择频道后，下方显示详细信息：
- 📡 码率（如：1024 kbps）
- 👥 观看人数
- ⏱️ 运行时长

### 4. 自动更新
- 每 10 秒自动刷新频道列表
- 保持当前选择（如果频道仍然存在）
- 后台静默更新，不影响用户操作

### 5. 智能排序
- 在线频道排在前面
- 离线频道排在后面
- 自动选择第一个在线频道

## 🎯 界面变化

### 修改前
```
流地址/名称: [demo          ]
```

### 修改后
```
选择频道: [🟢 yard-1 (2人观看) ▼] [🔄]
         📡 1024 kbps | 👥 2人观看 | ⏱️ 00:15:30
```

## 🔧 技术实现

### 1. HTML 结构
```html
<div class="mb-3">
  <label for="streamSelect" class="block mb-1.5 font-medium text-gray-600 text-sm">选择频道:</label>
  <div class="flex gap-2">
    <select id="streamSelect" class="flex-1 px-3 py-2 ...">
      <option value="">正在加载...</option>
    </select>
    <button id="refreshStreamsBtn" class="..." title="刷新频道列表">
      <i class="fas fa-sync-alt"></i>
    </button>
  </div>
  <div id="streamInfo" class="mt-2 text-xs text-gray-500 hidden"></div>
</div>
```

### 2. 核心方法

#### loadAvailableStreams()
从 `/api/statistics/streams` 获取频道列表
```javascript
async loadAvailableStreams() {
  const response = await fetch('/api/statistics/streams');
  const result = await response.json();
  // 渲染选项...
}
```

#### renderStreamOptions(streams)
渲染下拉选项，包含状态、观看人数等信息
```javascript
renderStreamOptions(streams) {
  // 按状态排序：在线的在前
  streams.sort((a, b) => {
    if (a.status === 'online' && b.status !== 'online') return -1;
    // ...
  });
  
  // 生成选项HTML
  this.elements.streamSelect.innerHTML = streams.map(stream => {
    const statusIcon = stream.status === 'online' ? '🟢' : '⚫';
    // ...
  }).join('');
}
```

#### updateStreamInfo()
更新选中频道的详细信息显示
```javascript
updateStreamInfo() {
  const selectedOption = this.elements.streamSelect.selectedOptions[0];
  // 显示码率、观看人数、运行时长
}
```

#### getStreamUrl()
根据选中的频道生成播放 URL
```javascript
getStreamUrl() {
  const streamPath = selectedOption.value; // "/live/yard-1"
  const protocol = this.elements.protocolSelect.value;
  
  switch (protocol) {
    case 'flv': return `${streamPath}.flv`;
    case 'hls': return `${streamPath}/index.m3u8`;
    case 'rtmp': return `rtmp://localhost${streamPath}`;
  }
}
```

### 3. 自动刷新机制
```javascript
constructor() {
  // ...
  // 每10秒自动刷新流列表
  this.streamRefreshInterval = setInterval(() => {
    this.loadAvailableStreams();
  }, 10000);
}
```

## 📊 API 数据格式

### 请求
```http
GET /api/statistics/streams
```

### 响应
```json
{
  "success": true,
  "data": [
    {
      "id": "/live/yard-1",
      "name": "yard-1",
      "viewers": 2,
      "bitrate": "1024 kbps",
      "status": "online",
      "uptime": "00:15:30",
      "protocol": "RTMP"
    },
    {
      "id": "/live/demo",
      "name": "demo",
      "viewers": 0,
      "bitrate": "0 kbps",
      "status": "offline",
      "uptime": "00:00:00",
      "protocol": "RTMP"
    }
  ],
  "timestamp": 1727683772855
}
```

## 🎨 用户体验优化

### 1. 视觉反馈
- ✅ 刷新按钮带旋转动画
- ✅ 在线/离线状态用图标区分
- ✅ 离线频道禁用（灰色显示）
- ✅ 频道信息实时更新

### 2. 智能选择
- ✅ 页面加载时自动选择第一个在线频道
- ✅ 刷新后保持当前选择
- ✅ 当前频道离线时自动切换到其他在线频道

### 3. 错误处理
- ✅ API 请求失败时显示错误信息
- ✅ 无可用频道时显示提示
- ✅ 播放前验证频道是否有效

### 4. 日志输出
所有操作都会记录到调试日志：
- 🔵 INFO: "正在加载频道列表..."
- 🟢 SUCCESS: "已加载 5 个频道"
- 🔴 ERROR: "加载频道列表失败: ..."

## 🧪 测试步骤

### 1. 启动服务器
```bash
node test-server.js
```

### 2. 推送测试流
```bash
# 推送到 yard-1
ffmpeg -re -i test.mp4 -c copy -f flv rtmp://localhost/live/yard-1

# 推送到 demo
ffmpeg -re -i test.mp4 -c copy -f flv rtmp://localhost/live/demo
```

### 3. 打开播放器
```
http://localhost:8000/static/index.html
```

### 4. 验证功能
- [x] 页面加载时自动获取频道列表
- [x] 下拉框显示所有频道（在线的在前）
- [x] 选择频道后显示详细信息
- [x] 点击刷新按钮更新列表（带动画）
- [x] 点击"开始播放"能正常播放选中的频道
- [x] 每 10 秒自动更新频道状态
- [x] 离线频道无法选择
- [x] 日志正确输出所有操作

## 🔍 问题排查

### 问题1：下拉框显示"正在加载..."不变
**原因**：API 未启动或路径错误
**解决**：
1. 检查服务器是否启动
2. 打开浏览器控制台查看请求错误
3. 验证 `/api/statistics/streams` 是否可访问

### 问题2：显示"暂无可用频道"
**原因**：没有推流
**解决**：
1. 使用 FFmpeg 或 OBS 推送至少一个流
2. 检查推流地址是否正确
3. 查看服务器日志确认推流成功

### 问题3：频道显示离线但实际在线
**原因**：统计数据未更新
**解决**：
1. 点击刷新按钮
2. 等待 10 秒自动刷新
3. 检查 StatisticsManager 是否正常运行

### 问题4：播放失败
**原因**：URL 生成错误或协议不匹配
**解决**：
1. 检查浏览器控制台的错误信息
2. 查看调试日志中的"连接地址"
3. 确认协议选择与推流协议一致

## 📈 性能考虑

### 1. API 调用频率
- 初始加载：1 次
- 手动刷新：按需
- 自动刷新：每 10 秒 1 次
- **优化**：使用 WebSocket 可进一步减少轮询

### 2. 内存占用
- 下拉选项数量随频道数增长
- 建议：频道数 < 100 时性能良好
- 超过 100 个频道考虑分页或搜索功能

### 3. 网络开销
- 单次请求大小：约 1-5 KB（取决于频道数）
- 每小时请求次数：360 次（10 秒间隔）
- **优化建议**：仅在页面可见时刷新（使用 Page Visibility API）

## 🚀 未来改进建议

### 1. 实时更新（WebSocket）
```javascript
const ws = new WebSocket('ws://localhost:8000/ws/statistics');
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  this.renderStreamOptions(data.streams);
};
```

### 2. 搜索过滤
```html
<input type="text" placeholder="搜索频道..." id="streamSearch">
```

### 3. 分组显示
按应用名（app）分组显示频道：
```
├─ live
│  ├─ 🟢 yard-1 (2人)
│  ├─ ⚫ demo (离线)
├─ broadcast
│  └─ 🟢 event-1 (15人)
```

### 4. 收藏功能
用户可以收藏常用频道，显示在列表顶部

### 5. 缩略图预览
在下拉框中显示频道的实时截图

## 📝 总结

✅ **已完成**：
- 将输入框改为下拉选择框
- 集成 `/api/statistics/streams` API
- 添加刷新按钮和自动更新
- 显示频道详细信息
- 优化用户体验和错误处理

🎉 **效果**：
- 用户可以轻松选择可用频道
- 实时查看频道状态和观看人数
- 无需手动输入频道名称
- 避免输入错误的频道名

🔧 **兼容性**：
- 保留了原有的播放器功能
- 支持 FLV、HLS、RTMP 协议切换
- 所有控制按钮正常工作
- 日志系统完整记录操作
