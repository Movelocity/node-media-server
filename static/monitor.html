<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stream Monitor - Performance Analytics</title>
  <link href="./lib/font-awesome.min.css" rel="stylesheet">
  <style>
    /* 动画效果 */
    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }

    .status-dot {
      animation: pulse 2s infinite;
    }

    /* 侧边导航栏过渡动画 */
    .sidebar {
      transition: width 0.3s ease;
    }

    /* 导航项激活状态 */
    .nav-item.active {
      background-color: #e5e7eb;
      border-left: 4px solid #3b82f6;
    }

    .nav-item:hover {
      background-color: #f3f4f6;
    }

    /* 折叠时的提示 */
    .sidebar.collapsed .nav-text {
      display: none;
    }

    .sidebar.collapsed .nav-item {
      justify-content: center;
    }
  </style>
  <script src="./lib/tailwind.min.js"></script>
</head>

<body class="font-sans bg-gray-100 h-screen text-gray-800 flex">
  <!-- 左侧导航栏 -->
  <aside id="sidebar" class="sidebar bg-white border-r border-gray-200 flex flex-col" style="width: 240px;">
    <!-- Logo区域 -->
    <div class="p-4 border-b border-gray-200 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="fas fa-video text-blue-600 text-xl"></i>
        <span class="nav-text font-bold text-gray-800 text-lg">流媒体中心</span>
      </div>
      <button id="sidebarToggle" class="text-gray-500 hover:text-gray-700 p-1">
        <i class="fas fa-bars"></i>
      </button>
    </div>

    <!-- 导航菜单 -->
    <nav class="flex-1 p-3">
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1" data-page="index.html">
        <i class="fas fa-play-circle text-lg text-gray-600"></i>
        <span class="nav-text text-gray-700 font-medium">播放器</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1" data-page="config.html">
        <i class="fas fa-cog text-lg text-gray-600"></i>
        <span class="nav-text text-gray-700 font-medium">配置管理</span>
      </div>
      <div class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1" data-page="monitor.html">
        <i class="fas fa-chart-line text-lg text-gray-600"></i>
        <span class="nav-text text-gray-700 font-medium">性能监控</span>
      </div>
      
      <!-- 分隔线 -->
      <div class="my-3 border-t border-gray-200"></div>
      
      <!-- 快捷操作 -->
      <div class="px-2 mb-2">
        <div class="nav-text text-xs text-gray-500 font-semibold uppercase tracking-wider px-2">快捷操作</div>
      </div>
      <div id="quickStartBtn" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1">
        <i class="fas fa-play text-lg text-green-600"></i>
        <span class="nav-text text-gray-700 font-medium">开始监控</span>
      </div>
      <div id="quickStopBtn" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1 opacity-50 pointer-events-none">
        <i class="fas fa-stop text-lg text-red-600"></i>
        <span class="nav-text text-gray-700 font-medium">停止监控</span>
      </div>
      <div id="quickDiagBtn" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer mb-1">
        <i class="fas fa-stethoscope text-lg text-blue-600"></i>
        <span class="nav-text text-gray-700 font-medium">运行诊断</span>
      </div>
    </nav>

    <!-- 底部状态 -->
    <div class="p-4 border-t border-gray-200">
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-gray-400" id="monitorStatus"></div>
        <span class="nav-text text-sm text-gray-600">监控已停止</span>
      </div>
    </div>
  </aside>

  <!-- 主内容区域 -->
  <main class="flex-1 overflow-auto">
    <!-- 顶部面包屑导航 -->
    <div class="bg-white border-b border-gray-200 px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <i class="fas fa-home"></i>
          <span class="text-gray-400">/</span>
          <span class="font-medium text-gray-800">性能监控</span>
        </div>
        <div class="flex gap-2">
          <button class="px-4 py-2 border-0 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 text-white bg-green-600 hover:bg-green-700" id="startMonitoringBtn">
            <i class="fas fa-play-circle"></i>
            开始监控
          </button>
          <button class="px-4 py-2 border-0 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 text-white bg-red-600 hover:bg-red-700 hidden" id="stopMonitoringBtn">
            <i class="fas fa-stop-circle"></i>
            停止监控
          </button>
          <button class="px-4 py-2 border-0 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 text-white bg-blue-600 hover:bg-blue-700" id="runDiagnosticsBtn">
            <i class="fas fa-stethoscope"></i>
            运行诊断
          </button>
        </div>
      </div>
    </div>

    <!-- 内容区域 -->
    <div class="p-6">
      <!-- Performance Summary -->
      <div class="flex justify-around bg-gradient-to-r from-blue-600 to-blue-500 text-white p-5 rounded-xl mb-5 shadow-sm" id="performanceSummary">
        <div class="text-center">
          <div class="text-3xl font-bold mb-1.5" id="uptimeValue">--</div>
          <div class="text-sm opacity-90">运行时间</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold mb-1.5" id="healthScore">--</div>
          <div class="text-sm opacity-90">健康评分</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold mb-1.5" id="activeConnections">--</div>
          <div class="text-sm opacity-90">活跃连接</div>
        </div>
      </div>

      <!-- Monitor Grid -->
      <div class="grid grid-cols-[repeat(auto-fit,minmax(300px,1fr))] gap-5 mb-5">
        <!-- Connection Status Card -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 transition-all duration-200 hover:shadow-md">
          <div class="flex items-center justify-between mb-4 pb-2.5 border-b border-gray-200">
            <div class="text-base font-semibold text-gray-800 flex items-center gap-2">
              <i class="fas fa-wifi text-blue-600"></i>
              连接状态
            </div>
            <div class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800" id="connectionStatusBadge">正常</div>
          </div>

          <div class="flex items-center gap-2.5 px-2.5 py-2 bg-gray-50 rounded-md mb-4">
            <div class="status-dot w-3 h-3 rounded-full bg-green-500" id="connectionDot"></div>
            <div>
              <div class="font-medium text-sm" id="connectionText">WebSocket 连接正常</div>
              <div class="text-xs text-gray-600" id="connectionDetails">延迟: 12ms | 重连次数: 0</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="latencyValue">--</div>
              <div class="text-xs text-gray-600 font-medium">延迟 (ms)</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="reconnectCount">0</div>
              <div class="text-xs text-gray-600 font-medium">重连次数</div>
            </div>
          </div>
        </div>

        <!-- Network Performance Card -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 transition-all duration-200 hover:shadow-md">
          <div class="flex items-center justify-between mb-4 pb-2.5 border-b border-gray-200">
            <div class="text-base font-semibold text-gray-800 flex items-center gap-2">
              <i class="fas fa-network-wired text-blue-600"></i>
              网络性能
            </div>
            <div class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800" id="networkStatusBadge">优秀</div>
          </div>

          <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="bandwidthValue">--</div>
              <div class="text-xs text-gray-600 font-medium">带宽 (Mbps)</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="packetLoss">0%</div>
              <div class="text-xs text-gray-600 font-medium">丢包率</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="jitterValue">--</div>
              <div class="text-xs text-gray-600 font-medium">抖动 (ms)</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="throughput">--</div>
              <div class="text-xs text-gray-600 font-medium">吞吐量</div>
            </div>
          </div>

          <div class="relative h-[180px] mt-4">
            <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm chart-loading">
              <i class="fas fa-spinner fa-spin mr-2"></i>图表加载中...
            </div>
            <canvas id="networkChart"></canvas>
          </div>
        </div>

        <!-- Stream Quality Card -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 transition-all duration-200 hover:shadow-md">
          <div class="flex items-center justify-between mb-4 pb-2.5 border-b border-gray-200">
            <div class="text-base font-semibold text-gray-800 flex items-center gap-2">
              <i class="fas fa-video text-blue-600"></i>
              流媒体质量
            </div>
            <div class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800" id="qualityStatusBadge">高清</div>
          </div>

          <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="bitrateValue">--</div>
              <div class="text-xs text-gray-600 font-medium">码率 (kbps)</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="fpsValue">--</div>
              <div class="text-xs text-gray-600 font-medium">帧率 (fps)</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="resolutionValue">--</div>
              <div class="text-xs text-gray-600 font-medium">分辨率</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="droppedFrames">0</div>
              <div class="text-xs text-gray-600 font-medium">丢帧数</div>
            </div>
          </div>

          <div class="relative h-[180px] mt-4">
            <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm chart-loading">
              <i class="fas fa-spinner fa-spin mr-2"></i>图表加载中...
            </div>
            <canvas id="qualityChart"></canvas>
          </div>
        </div>

        <!-- System Resources Card -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 transition-all duration-200 hover:shadow-md">
          <div class="flex items-center justify-between mb-4 pb-2.5 border-b border-gray-200">
            <div class="text-base font-semibold text-gray-800 flex items-center gap-2">
              <i class="fas fa-microchip text-blue-600"></i>
              系统资源
            </div>
            <div class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800" id="resourceStatusBadge">适中</div>
          </div>

          <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="cpuUsage">--</div>
              <div class="text-xs text-gray-600 font-medium">CPU 使用率</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="memoryUsage">--</div>
              <div class="text-xs text-gray-600 font-medium">内存使用率</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="bufferLevel">--</div>
              <div class="text-xs text-gray-600 font-medium">缓冲水平</div>
            </div>
            <div class="text-center px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="text-xl font-bold text-blue-600 mb-1" id="networkSpeed">--</div>
              <div class="text-xs text-gray-600 font-medium">网络速度</div>
            </div>
          </div>

          <div>
            <div class="flex justify-between text-xs mb-1.5">
              <span class="text-gray-600">CPU</span>
              <span id="cpuPercent" class="font-medium">0%</span>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded overflow-hidden my-2">
              <div class="h-full bg-gradient-to-r from-blue-500 to-green-500 transition-[width] duration-300 ease-in-out" id="cpuProgress" style="width: 0%"></div>
            </div>

            <div class="flex justify-between text-xs mb-1.5 mt-3">
              <span class="text-gray-600">内存</span>
              <span id="memoryPercent" class="font-medium">0%</span>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded overflow-hidden my-2">
              <div class="h-full bg-gradient-to-r from-blue-500 to-green-500 transition-[width] duration-300 ease-in-out" id="memoryProgress" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <!-- Real-time Log Panel -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 col-span-full">
          <div class="flex items-center justify-between mb-4 pb-2.5 border-b border-gray-200">
            <div class="text-base font-semibold text-gray-800 flex items-center gap-2">
              <i class="fas fa-terminal text-blue-600"></i>
              实时日志
            </div>
            <div class="flex gap-2">
              <button class="px-2 py-1.5 border-0 rounded cursor-pointer text-xs font-medium transition-all duration-200 text-white bg-green-600 hover:bg-green-700" id="pauseLogBtn">
                <i class="fas fa-pause"></i>
              </button>
              <button class="px-2 py-1.5 border-0 rounded cursor-pointer text-xs font-medium transition-all duration-200 text-white bg-blue-600 hover:bg-blue-700" id="exportLogBtn">
                <i class="fas fa-download"></i>
              </button>
              <button class="px-2 py-1.5 border-0 rounded cursor-pointer text-xs font-medium transition-all duration-200 text-white bg-red-600 hover:bg-red-700" id="clearLogBtn">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>

          <div class="bg-gray-900 text-gray-100 rounded-md px-4 py-3 h-[280px] overflow-y-auto font-mono text-xs leading-relaxed" id="logContent">
            <div class="mb-1 break-words">
              <span class="text-gray-500 mr-2">00:00:00.000</span>
              <span class="text-cyan-400">[INFO]</span>
              <span>监控系统初始化完成</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Diagnostic Section -->
      <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 mt-5 hidden" id="diagnosticSection">
        <div class="flex items-center justify-between mb-4 pb-2.5 border-b border-gray-200">
          <div class="text-base font-semibold text-gray-800 flex items-center gap-2">
            <i class="fas fa-stethoscope text-blue-600"></i>
            系统诊断报告
          </div>
          <div id="diagnosticProgress" class="hidden">
            <div class="w-[200px] h-2 bg-gray-200 rounded overflow-hidden">
              <div class="h-full bg-gradient-to-r from-blue-500 to-green-500 transition-[width] duration-300 ease-in-out" id="diagnosticProgressBar" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-[repeat(auto-fit,minmax(250px,1fr))] gap-4" id="diagnosticResults">
          <!-- 诊断结果将在这里动态生成 -->
        </div>
      </div>
    </div>
  </main>

  <!-- 异步加载 Chart.js，不阻塞页面渲染 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  
  <script>
    // 侧边栏折叠功能
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar.style.width === '240px') {
        sidebar.style.width = '80px';
        sidebar.classList.add('collapsed');
      } else {
        sidebar.style.width = '240px';
        sidebar.classList.remove('collapsed');
      }
    });

    // 导航项点击事件
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', function() {
        const page = this.dataset.page;
        window.location.href = page;
      });
    });

    class StreamMonitor {
      constructor() {
        this.isMonitoring = false;
        this.isLogPaused = false;
        this.startTime = null;
        this.chartsReady = false;
        this.data = {
          network: [],
          quality: [],
          timestamps: []
        };
        this.maxDataPoints = 30;

        this.initializeElements();
        this.bindEvents();
        this.log('info', '监控系统初始化中...');
        
        // 异步初始化图表，不阻塞页面渲染
        requestAnimationFrame(() => {
          this.initializeCharts().then(() => {
            this.log('info', '监控系统初始化完成');
          });
        });
      }

      initializeElements() {
        this.elements = {
          startBtn: document.getElementById('startMonitoringBtn'),
          stopBtn: document.getElementById('stopMonitoringBtn'),
          diagnosticBtn: document.getElementById('runDiagnosticsBtn'),
          logContent: document.getElementById('logContent'),
          pauseLogBtn: document.getElementById('pauseLogBtn'),
          exportLogBtn: document.getElementById('exportLogBtn'),
          clearLogBtn: document.getElementById('clearLogBtn'),
          diagnosticSection: document.getElementById('diagnosticSection'),
          diagnosticResults: document.getElementById('diagnosticResults'),
          diagnosticProgress: document.getElementById('diagnosticProgress'),
          diagnosticProgressBar: document.getElementById('diagnosticProgressBar'),
          quickStartBtn: document.getElementById('quickStartBtn'),
          quickStopBtn: document.getElementById('quickStopBtn'),
          quickDiagBtn: document.getElementById('quickDiagBtn'),
          monitorStatus: document.getElementById('monitorStatus'),

          // Performance summary
          uptimeValue: document.getElementById('uptimeValue'),
          healthScore: document.getElementById('healthScore'),
          activeConnections: document.getElementById('activeConnections'),

          // Status badges
          connectionStatusBadge: document.getElementById('connectionStatusBadge'),
          networkStatusBadge: document.getElementById('networkStatusBadge'),
          qualityStatusBadge: document.getElementById('qualityStatusBadge'),
          resourceStatusBadge: document.getElementById('resourceStatusBadge'),

          // Connection metrics
          connectionDot: document.getElementById('connectionDot'),
          connectionText: document.getElementById('connectionText'),
          connectionDetails: document.getElementById('connectionDetails'),
          latencyValue: document.getElementById('latencyValue'),
          reconnectCount: document.getElementById('reconnectCount'),

          // Network metrics
          bandwidthValue: document.getElementById('bandwidthValue'),
          packetLoss: document.getElementById('packetLoss'),
          jitterValue: document.getElementById('jitterValue'),
          throughput: document.getElementById('throughput'),

          // Quality metrics
          bitrateValue: document.getElementById('bitrateValue'),
          fpsValue: document.getElementById('fpsValue'),
          resolutionValue: document.getElementById('resolutionValue'),
          droppedFrames: document.getElementById('droppedFrames'),

          // Resource metrics
          cpuUsage: document.getElementById('cpuUsage'),
          memoryUsage: document.getElementById('memoryUsage'),
          bufferLevel: document.getElementById('bufferLevel'),
          networkSpeed: document.getElementById('networkSpeed'),
          cpuPercent: document.getElementById('cpuPercent'),
          memoryPercent: document.getElementById('memoryPercent'),
          cpuProgress: document.getElementById('cpuProgress'),
          memoryProgress: document.getElementById('memoryProgress')
        };
      }

      async initializeCharts() {
        // 等待 Chart.js 加载完成
        while (typeof Chart === 'undefined') {
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        // 延迟图表初始化，让页面先渲染
        await new Promise(resolve => setTimeout(resolve, 0));
        
        // 网络性能图表
        const networkCtx = document.getElementById('networkChart').getContext('2d');
        this.networkChart = new Chart(networkCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: '带宽 (Mbps)',
              data: [],
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f3f4f6' }
              },
              x: {
                grid: { color: '#f3f4f6' }
              }
            },
            plugins: {
              legend: { display: false }
            },
            animation: {
              duration: 0 // 禁用初始动画，加快加载
            }
          }
        });

        // 质量监控图表
        const qualityCtx = document.getElementById('qualityChart').getContext('2d');
        this.qualityChart = new Chart(qualityCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: '码率 (kbps)',
              data: [],
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f3f4f6' }
              },
              x: {
                grid: { color: '#f3f4f6' }
              }
            },
            plugins: {
              legend: { display: false }
            },
            animation: {
              duration: 0 // 禁用初始动画，加快加载
            }
          }
        });
        
        this.chartsReady = true;
        
        // 隐藏图表加载提示
        document.querySelectorAll('.chart-loading').forEach(el => {
          el.style.display = 'none';
        });
      }

      bindEvents() {
        this.elements.startBtn.addEventListener('click', () => this.startMonitoring());
        this.elements.stopBtn.addEventListener('click', () => this.stopMonitoring());
        this.elements.diagnosticBtn.addEventListener('click', () => this.runDiagnostics());
        this.elements.pauseLogBtn.addEventListener('click', () => this.toggleLogPause());
        this.elements.exportLogBtn.addEventListener('click', () => this.exportLog());
        this.elements.clearLogBtn.addEventListener('click', () => this.clearLog());
        
        this.elements.quickStartBtn.addEventListener('click', () => this.startMonitoring());
        this.elements.quickStopBtn.addEventListener('click', () => this.stopMonitoring());
        this.elements.quickDiagBtn.addEventListener('click', () => this.runDiagnostics());
      }

      startMonitoring() {
        this.isMonitoring = true;
        this.startTime = Date.now();
        this.elements.startBtn.classList.add('hidden');
        this.elements.stopBtn.classList.remove('hidden');
        this.elements.quickStartBtn.classList.add('opacity-50', 'pointer-events-none');
        this.elements.quickStopBtn.classList.remove('opacity-50', 'pointer-events-none');
        this.elements.monitorStatus.className = 'w-2 h-2 rounded-full bg-green-500';

        this.log('success', '开始监控流媒体性能');
        this.updateMetrics();
        this.monitoringInterval = setInterval(() => this.updateMetrics(), 2000);
      }

      stopMonitoring() {
        this.isMonitoring = false;
        this.elements.startBtn.classList.remove('hidden');
        this.elements.stopBtn.classList.add('hidden');
        this.elements.quickStartBtn.classList.remove('opacity-50', 'pointer-events-none');
        this.elements.quickStopBtn.classList.add('opacity-50', 'pointer-events-none');
        this.elements.monitorStatus.className = 'w-2 h-2 rounded-full bg-gray-400';

        if (this.monitoringInterval) {
          clearInterval(this.monitoringInterval);
        }

        this.log('info', '停止监控');
      }

      updateMetrics() {
        if (!this.isMonitoring) return;

        // 更新运行时间
        if (this.startTime) {
          const uptime = Math.floor((Date.now() - this.startTime) / 1000);
          this.elements.uptimeValue.textContent = this.formatUptime(uptime);
        }

        // 模拟网络指标
        const bandwidth = (Math.random() * 10 + 5).toFixed(1);
        const latency = Math.floor(Math.random() * 50 + 10);
        const packetLoss = (Math.random() * 2).toFixed(1);
        const jitter = Math.floor(Math.random() * 10 + 2);

        this.elements.bandwidthValue.textContent = bandwidth;
        this.elements.latencyValue.textContent = latency;
        this.elements.packetLoss.textContent = packetLoss + '%';
        this.elements.jitterValue.textContent = jitter;
        this.elements.throughput.textContent = (bandwidth * 0.8).toFixed(1) + 'M';

        // 模拟质量指标
        const bitrate = Math.floor(Math.random() * 1000 + 1500);
        const fps = Math.floor(Math.random() * 10 + 25);
        const droppedFrames = Math.floor(Math.random() * 5);

        this.elements.bitrateValue.textContent = bitrate;
        this.elements.fpsValue.textContent = fps;
        this.elements.resolutionValue.textContent = '1920x1080';
        this.elements.droppedFrames.textContent = droppedFrames;

        // 模拟系统资源
        const cpuUsage = Math.floor(Math.random() * 40 + 20);
        const memoryUsage = Math.floor(Math.random() * 30 + 40);

        this.elements.cpuUsage.textContent = cpuUsage + '%';
        this.elements.memoryUsage.textContent = memoryUsage + '%';
        this.elements.bufferLevel.textContent = Math.floor(Math.random() * 500 + 100) + 'ms';
        this.elements.networkSpeed.textContent = bandwidth + 'Mbps';

        this.elements.cpuPercent.textContent = cpuUsage + '%';
        this.elements.memoryPercent.textContent = memoryUsage + '%';
        this.elements.cpuProgress.style.width = cpuUsage + '%';
        this.elements.memoryProgress.style.width = memoryUsage + '%';

        // 更新健康评分
        const healthScore = Math.floor(100 - (latency / 10 + parseFloat(packetLoss) * 10 + cpuUsage / 2));
        this.elements.healthScore.textContent = Math.max(healthScore, 60);
        this.elements.activeConnections.textContent = Math.floor(Math.random() * 5 + 1);

        // 更新状态
        this.updateConnectionStatus(latency, packetLoss);
        this.updateNetworkStatus(bandwidth, packetLoss);
        this.updateQualityStatus(fps, droppedFrames);
        this.updateResourceStatus(cpuUsage, memoryUsage);

        // 更新图表
        this.updateCharts(bandwidth, bitrate);

        // 记录日志
        if (Math.random() < 0.3) { // 30% 概率记录日志
          const logTypes = ['info', 'warn'];
          const logType = logTypes[Math.floor(Math.random() * logTypes.length)];
          const messages = [
            `网络延迟: ${latency}ms`,
            `当前码率: ${bitrate}kbps`,
            `缓冲区状态良好`,
            `检测到轻微网络波动`,
            `流质量稳定`
          ];
          const message = messages[Math.floor(Math.random() * messages.length)];
          this.log(logType, message);
        }
      }

      updateConnectionStatus(latency, packetLoss) {
        if (latency < 30 && packetLoss < 1) {
          this.elements.connectionStatusBadge.textContent = '优秀';
          this.elements.connectionStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800';
          this.elements.connectionDot.className = 'status-dot w-3 h-3 rounded-full bg-green-500';
          this.elements.connectionText.textContent = '连接状态优秀';
        } else if (latency < 60 && packetLoss < 3) {
          this.elements.connectionStatusBadge.textContent = '良好';
          this.elements.connectionStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800';
          this.elements.connectionDot.className = 'status-dot w-3 h-3 rounded-full bg-yellow-400';
          this.elements.connectionText.textContent = '连接状态良好';
        } else {
          this.elements.connectionStatusBadge.textContent = '较差';
          this.elements.connectionStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800';
          this.elements.connectionDot.className = 'status-dot w-3 h-3 rounded-full bg-red-500';
          this.elements.connectionText.textContent = '连接质量较差';
        }

        this.elements.connectionDetails.textContent = `延迟: ${latency}ms | 丢包率: ${packetLoss}%`;
      }

      updateNetworkStatus(bandwidth, packetLoss) {
        if (bandwidth > 8 && packetLoss < 1) {
          this.elements.networkStatusBadge.textContent = '优秀';
          this.elements.networkStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800';
        } else if (bandwidth > 5 && packetLoss < 2) {
          this.elements.networkStatusBadge.textContent = '良好';
          this.elements.networkStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800';
        } else {
          this.elements.networkStatusBadge.textContent = '较差';
          this.elements.networkStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800';
        }
      }

      updateQualityStatus(fps, droppedFrames) {
        if (fps >= 28 && droppedFrames < 2) {
          this.elements.qualityStatusBadge.textContent = '高清';
          this.elements.qualityStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800';
        } else if (fps >= 25 && droppedFrames < 5) {
          this.elements.qualityStatusBadge.textContent = '标清';
          this.elements.qualityStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800';
        } else {
          this.elements.qualityStatusBadge.textContent = '较差';
          this.elements.qualityStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800';
        }
      }

      updateResourceStatus(cpu, memory) {
        if (cpu < 40 && memory < 60) {
          this.elements.resourceStatusBadge.textContent = '轻负载';
          this.elements.resourceStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800';
        } else if (cpu < 70 && memory < 80) {
          this.elements.resourceStatusBadge.textContent = '适中';
          this.elements.resourceStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800';
        } else {
          this.elements.resourceStatusBadge.textContent = '高负载';
          this.elements.resourceStatusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800';
        }
      }

      updateCharts(bandwidth, bitrate) {
        const now = new Date().toLocaleTimeString();

        // 更新数据
        this.data.timestamps.push(now);
        this.data.network.push(parseFloat(bandwidth));
        this.data.quality.push(bitrate);

        // 限制数据点数量
        if (this.data.timestamps.length > this.maxDataPoints) {
          this.data.timestamps.shift();
          this.data.network.shift();
          this.data.quality.shift();
        }

        // 只有在图表准备好时才更新
        if (!this.chartsReady) return;

        // 更新网络图表
        this.networkChart.data.labels = this.data.timestamps;
        this.networkChart.data.datasets[0].data = this.data.network;
        this.networkChart.update('none'); // 使用 'none' 模式避免动画延迟

        // 更新质量图表
        this.qualityChart.data.labels = this.data.timestamps;
        this.qualityChart.data.datasets[0].data = this.data.quality;
        this.qualityChart.update('none'); // 使用 'none' 模式避免动画延迟
      }

      async runDiagnostics() {
        this.elements.diagnosticSection.classList.remove('hidden');
        this.elements.diagnosticProgress.classList.remove('hidden');
        this.elements.diagnosticResults.innerHTML = '';

        this.log('info', '开始运行系统诊断...');

        const diagnostics = [
          { name: '网络连接测试', check: () => this.checkNetworkConnection() },
          { name: '服务器可达性', check: () => this.checkServerReachability() },
          { name: '浏览器兼容性', check: () => this.checkBrowserCompatibility() },
          { name: '解码器支持', check: () => this.checkCodecSupport() },
          { name: '带宽测试', check: () => this.checkBandwidth() },
          { name: '延迟测试', check: () => this.checkLatency() }
        ];

        for (let i = 0; i < diagnostics.length; i++) {
          const diagnostic = diagnostics[i];
          const progress = ((i + 1) / diagnostics.length) * 100;
          this.elements.diagnosticProgressBar.style.width = progress + '%';

          const result = await diagnostic.check();
          this.addDiagnosticResult(diagnostic.name, result);

          // 模拟诊断时间
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        this.elements.diagnosticProgress.classList.add('hidden');
        this.log('success', '系统诊断完成');
      }

      async checkNetworkConnection() {
        try {
          const start = Date.now();
          await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' });
          const latency = Date.now() - start;
          return {
            status: latency < 100 ? 'pass' : 'warning',
            message: `网络连接正常 (${latency}ms)`,
            details: '可以正常访问外部网络'
          };
        } catch (error) {
          return {
            status: 'fail',
            message: '网络连接失败',
            details: '无法访问外部网络，请检查网络配置'
          };
        }
      }

      async checkServerReachability() {
        // 模拟服务器检查
        const isReachable = Math.random() > 0.1; // 90% 成功率
        return {
          status: isReachable ? 'pass' : 'fail',
          message: isReachable ? '流媒体服务器可达' : '流媒体服务器不可达',
          details: isReachable ? '服务器响应正常' : '请检查服务器状态和网络连接'
        };
      }

      checkBrowserCompatibility() {
        const isSupported = !!window.MediaSource;
        return {
          status: isSupported ? 'pass' : 'fail',
          message: isSupported ? '浏览器兼容性良好' : '浏览器不支持流媒体',
          details: isSupported ? '支持 MSE 和现代流媒体标准' : '请使用支持 HTML5 的现代浏览器'
        };
      }

      checkCodecSupport() {
        const video = document.createElement('video');
        const h264Support = video.canPlayType('video/mp4; codecs="avc1.42E01E"');
        return {
          status: h264Support ? 'pass' : 'warning',
          message: h264Support ? 'H.264 编码器支持' : '有限的编码器支持',
          details: h264Support ? '支持 H.264 视频编码' : '可能需要安装额外的编码器'
        };
      }

      async checkBandwidth() {
        // 模拟带宽测试
        const bandwidth = Math.random() * 10 + 5;
        return {
          status: bandwidth > 5 ? 'pass' : 'warning',
          message: `带宽: ${bandwidth.toFixed(1)} Mbps`,
          details: bandwidth > 5 ? '带宽充足，适合高清流媒体' : '带宽较低，可能影响播放质量'
        };
      }

      async checkLatency() {
        // 模拟延迟测试
        const latency = Math.floor(Math.random() * 100 + 20);
        return {
          status: latency < 50 ? 'pass' : latency < 100 ? 'warning' : 'fail',
          message: `网络延迟: ${latency}ms`,
          details: latency < 50 ? '延迟很低，实时性很好' :
            latency < 100 ? '延迟适中，可以接受' : '延迟较高，可能影响实时性'
        };
      }

      addDiagnosticResult(name, result) {
        const diagnosticItem = document.createElement('div');
        diagnosticItem.className = 'border border-gray-200 rounded-lg p-4';

        const statusClass = {
          'pass': 'bg-green-100 text-green-800',
          'warning': 'bg-yellow-100 text-yellow-800',
          'fail': 'bg-red-100 text-red-800'
        }[result.status];

        const statusText = {
          'pass': '通过',
          'warning': '警告',
          'fail': '失败'
        }[result.status];

        diagnosticItem.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <div class="font-medium text-gray-800 text-sm">${name}</div>
            <div class="px-2 py-1 rounded text-xs font-semibold ${statusClass}">
              ${statusText}
            </div>
          </div>
          <div class="mb-2 font-medium text-sm">${result.message}</div>
          <div class="text-gray-600 text-xs leading-relaxed">${result.details}</div>
        `;

        this.elements.diagnosticResults.appendChild(diagnosticItem);
      }

      toggleLogPause() {
        this.isLogPaused = !this.isLogPaused;
        this.elements.pauseLogBtn.innerHTML = this.isLogPaused ?
          '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';

        this.log('info', this.isLogPaused ? '日志已暂停' : '日志已恢复');
      }

      exportLog() {
        const logEntries = Array.from(this.elements.logContent.children);
        const logText = logEntries.map(entry => entry.textContent).join('\n');

        const blob = new Blob([logText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `stream-monitor-log-${new Date().toISOString().split('T')[0]}.txt`;
        a.click();

        URL.revokeObjectURL(url);
        this.log('success', '日志已导出');
      }

      clearLog() {
        this.elements.logContent.innerHTML = '';
        this.log('info', '日志已清空');
      }

      log(level, message) {
        if (this.isLogPaused) return;

        const timestamp = new Date().toLocaleTimeString() + '.' +
          Date.now().toString().slice(-3);
        const logEntry = document.createElement('div');
        logEntry.className = 'mb-1 break-words';

        const colorClass = {
          'info': 'text-cyan-400',
          'warn': 'text-yellow-300',
          'error': 'text-red-400',
          'success': 'text-green-400'
        }[level] || 'text-gray-400';

        logEntry.innerHTML = `
          <span class="text-gray-500 mr-2">${timestamp}</span>
          <span class="${colorClass}">[${level.toUpperCase()}]</span>
          <span>${message}</span>
        `;

        this.elements.logContent.appendChild(logEntry);
        this.elements.logContent.scrollTop = this.elements.logContent.scrollHeight;

        // 限制日志条数
        const logEntries = this.elements.logContent.children;
        if (logEntries.length > 200) {
          this.elements.logContent.removeChild(logEntries[0]);
        }
      }

      formatUptime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        if (hours > 0) {
          return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
          return `${minutes}m ${secs}s`;
        } else {
          return `${secs}s`;
        }
      }
    }

    // 初始化监控系统
    document.addEventListener('DOMContentLoaded', () => {
      window.streamMonitor = new StreamMonitor();
    });
  </script>
</body>

</html>