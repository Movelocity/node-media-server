<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stream Monitor - Performance Analytics</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .nav-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 10px 20px;
      background: white;
      color: #1e3c72;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .monitor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .monitor-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s;
    }

    .monitor-card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f1f3f4;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-good {
      background: #d4edda;
      color: #155724;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .metric-item {
      text-align: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #1e3c72;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 0.8rem;
      color: #666;
      font-weight: 500;
    }

    .chart-container {
      position: relative;
      height: 200px;
      margin-top: 15px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .dot-green {
      background: #28a745;
    }

    .dot-yellow {
      background: #ffc107;
    }

    .dot-red {
      background: #dc3545;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    .log-panel {
      grid-column: 1 / -1;
      max-height: 400px;
      overflow: hidden;
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .log-controls {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.3s;
      color: white;
    }

    .btn-primary {
      background: #007bff;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-success {
      background: #28a745;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }

    .log-content {
      background: #1e1e1e;
      color: #f8f8f2;
      border-radius: 6px;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
    }

    .log-entry {
      margin-bottom: 5px;
      word-wrap: break-word;
    }

    .log-timestamp {
      color: #6c7b7f;
      margin-right: 10px;
    }

    .log-level-info {
      color: #61dafb;
    }

    .log-level-warn {
      color: #f1c40f;
    }

    .log-level-error {
      color: #e74c3c;
    }

    .log-level-success {
      color: #2ecc71;
    }

    .diagnostic-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      grid-column: 1 / -1;
      margin-top: 20px;
    }

    .diagnostic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .diagnostic-item {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
    }

    .diagnostic-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .diagnostic-title {
      font-weight: 600;
      color: #333;
    }

    .diagnostic-result {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .result-pass {
      background: #d4edda;
      color: #155724;
    }

    .result-fail {
      background: #f8d7da;
      color: #721c24;
    }

    .result-warning {
      background: #fff3cd;
      color: #856404;
    }

    .diagnostic-details {
      color: #666;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #28a745);
      transition: width 0.3s ease;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 15px;
      border-left: 4px solid;
    }

    .alert-info {
      background: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
    }

    .alert-warning {
      background: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }

    .alert-danger {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }

    @media (max-width: 768px) {
      .monitor-grid {
        grid-template-columns: 1fr;
      }

      .nav-bar {
        flex-direction: column;
        align-items: center;
      }

      .metric-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .performance-summary {
      display: flex;
      justify-content: space-around;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .summary-item {
      text-align: center;
    }

    .summary-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .summary-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-chart-line"></i> Stream Monitor</h1>
      <p>实时性能监控与诊断分析</p>
    </div>

    <div class="nav-bar">
      <a href="index.html" class="nav-btn">
        <i class="fas fa-play"></i>
        播放器
      </a>
      <a href="config.html" class="nav-btn">
        <i class="fas fa-cog"></i>
        配置管理
      </a>
      <button class="nav-btn" id="startMonitoringBtn">
        <i class="fas fa-play-circle"></i>
        开始监控
      </button>
      <button class="nav-btn" id="stopMonitoringBtn" style="display: none;">
        <i class="fas fa-stop-circle"></i>
        停止监控
      </button>
      <button class="nav-btn" id="runDiagnosticsBtn">
        <i class="fas fa-stethoscope"></i>
        运行诊断
      </button>
    </div>

    <div class="performance-summary" id="performanceSummary">
      <div class="summary-item">
        <div class="summary-value" id="uptimeValue">--</div>
        <div class="summary-label">运行时间</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="healthScore">--</div>
        <div class="summary-label">健康评分</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="activeConnections">--</div>
        <div class="summary-label">活跃连接</div>
      </div>
    </div>

    <div class="monitor-grid">
      <!-- 连接状态监控 -->
      <div class="monitor-card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-wifi"></i>
            连接状态
          </div>
          <div class="card-status status-good" id="connectionStatusBadge">正常</div>
        </div>

        <div class="connection-status">
          <div class="status-dot dot-green" id="connectionDot"></div>
          <div>
            <div style="font-weight: 600;" id="connectionText">WebSocket 连接正常</div>
            <div style="font-size: 0.8rem; color: #666;" id="connectionDetails">延迟: 12ms | 重连次数: 0</div>
          </div>
        </div>

        <div class="metric-grid">
          <div class="metric-item">
            <div class="metric-value" id="latencyValue">--</div>
            <div class="metric-label">延迟 (ms)</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="reconnectCount">0</div>
            <div class="metric-label">重连次数</div>
          </div>
        </div>
      </div>

      <!-- 网络性能 -->
      <div class="monitor-card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-network-wired"></i>
            网络性能
          </div>
          <div class="card-status status-good" id="networkStatusBadge">优秀</div>
        </div>

        <div class="metric-grid">
          <div class="metric-item">
            <div class="metric-value" id="bandwidthValue">--</div>
            <div class="metric-label">带宽 (Mbps)</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="packetLoss">0%</div>
            <div class="metric-label">丢包率</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="jitterValue">--</div>
            <div class="metric-label">抖动 (ms)</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="throughput">--</div>
            <div class="metric-label">吞吐量</div>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="networkChart"></canvas>
        </div>
      </div>

      <!-- 流媒体质量 -->
      <div class="monitor-card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-video"></i>
            流媒体质量
          </div>
          <div class="card-status status-good" id="qualityStatusBadge">高清</div>
        </div>

        <div class="metric-grid">
          <div class="metric-item">
            <div class="metric-value" id="bitrateValue">--</div>
            <div class="metric-label">码率 (kbps)</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="fpsValue">--</div>
            <div class="metric-label">帧率 (fps)</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="resolutionValue">--</div>
            <div class="metric-label">分辨率</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="droppedFrames">0</div>
            <div class="metric-label">丢帧数</div>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="qualityChart"></canvas>
        </div>
      </div>

      <!-- 系统资源 -->
      <div class="monitor-card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-microchip"></i>
            系统资源
          </div>
          <div class="card-status status-warning" id="resourceStatusBadge">适中</div>
        </div>

        <div class="metric-grid">
          <div class="metric-item">
            <div class="metric-value" id="cpuUsage">--</div>
            <div class="metric-label">CPU 使用率</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="memoryUsage">--</div>
            <div class="metric-label">内存使用率</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="bufferLevel">--</div>
            <div class="metric-label">缓冲水平</div>
          </div>
          <div class="metric-item">
            <div class="metric-value" id="networkSpeed">--</div>
            <div class="metric-label">网络速度</div>
          </div>
        </div>

        <div>
          <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px;">
            <span>CPU</span>
            <span id="cpuPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="cpuProgress" style="width: 0%"></div>
          </div>

          <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px;">
            <span>内存</span>
            <span id="memoryPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="memoryProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- 实时日志 -->
      <div class="monitor-card log-panel">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-terminal"></i>
            实时日志
          </div>
          <div class="log-controls">
            <button class="btn btn-success" id="pauseLogBtn">
              <i class="fas fa-pause"></i>
            </button>
            <button class="btn btn-warning" id="exportLogBtn">
              <i class="fas fa-download"></i>
            </button>
            <button class="btn btn-danger" id="clearLogBtn">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="log-content" id="logContent">
          <div class="log-entry">
            <span class="log-timestamp">00:00:00.000</span>
            <span class="log-level-info">[INFO]</span>
            <span>监控系统初始化完成</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 诊断部分 -->
    <div class="diagnostic-section" id="diagnosticSection" style="display: none;">
      <div class="card-header">
        <div class="card-title">
          <i class="fas fa-stethoscope"></i>
          系统诊断报告
        </div>
        <div id="diagnosticProgress" style="display: none;">
          <div class="progress-bar" style="width: 200px;">
            <div class="progress-fill" id="diagnosticProgressBar" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="diagnostic-grid" id="diagnosticResults">
        <!-- 诊断结果将在这里动态生成 -->
      </div>
    </div>
  </div>

  <script>
    class StreamMonitor {
      constructor() {
        this.isMonitoring = false;
        this.isLogPaused = false;
        this.startTime = null;
        this.data = {
          network: [],
          quality: [],
          timestamps: []
        };
        this.maxDataPoints = 30;

        this.initializeElements();
        this.initializeCharts();
        this.bindEvents();
        this.log('info', '监控系统初始化完成');
      }

      initializeElements() {
        this.elements = {
          startBtn: document.getElementById('startMonitoringBtn'),
          stopBtn: document.getElementById('stopMonitoringBtn'),
          diagnosticBtn: document.getElementById('runDiagnosticsBtn'),
          logContent: document.getElementById('logContent'),
          pauseLogBtn: document.getElementById('pauseLogBtn'),
          exportLogBtn: document.getElementById('exportLogBtn'),
          clearLogBtn: document.getElementById('clearLogBtn'),
          diagnosticSection: document.getElementById('diagnosticSection'),
          diagnosticResults: document.getElementById('diagnosticResults'),
          diagnosticProgress: document.getElementById('diagnosticProgress'),
          diagnosticProgressBar: document.getElementById('diagnosticProgressBar'),

          // Performance summary
          uptimeValue: document.getElementById('uptimeValue'),
          healthScore: document.getElementById('healthScore'),
          activeConnections: document.getElementById('activeConnections'),

          // Status badges
          connectionStatusBadge: document.getElementById('connectionStatusBadge'),
          networkStatusBadge: document.getElementById('networkStatusBadge'),
          qualityStatusBadge: document.getElementById('qualityStatusBadge'),
          resourceStatusBadge: document.getElementById('resourceStatusBadge'),

          // Connection metrics
          connectionDot: document.getElementById('connectionDot'),
          connectionText: document.getElementById('connectionText'),
          connectionDetails: document.getElementById('connectionDetails'),
          latencyValue: document.getElementById('latencyValue'),
          reconnectCount: document.getElementById('reconnectCount'),

          // Network metrics
          bandwidthValue: document.getElementById('bandwidthValue'),
          packetLoss: document.getElementById('packetLoss'),
          jitterValue: document.getElementById('jitterValue'),
          throughput: document.getElementById('throughput'),

          // Quality metrics
          bitrateValue: document.getElementById('bitrateValue'),
          fpsValue: document.getElementById('fpsValue'),
          resolutionValue: document.getElementById('resolutionValue'),
          droppedFrames: document.getElementById('droppedFrames'),

          // Resource metrics
          cpuUsage: document.getElementById('cpuUsage'),
          memoryUsage: document.getElementById('memoryUsage'),
          bufferLevel: document.getElementById('bufferLevel'),
          networkSpeed: document.getElementById('networkSpeed'),
          cpuPercent: document.getElementById('cpuPercent'),
          memoryPercent: document.getElementById('memoryPercent'),
          cpuProgress: document.getElementById('cpuProgress'),
          memoryProgress: document.getElementById('memoryProgress')
        };
      }

      initializeCharts() {
        // 网络性能图表
        const networkCtx = document.getElementById('networkChart').getContext('2d');
        this.networkChart = new Chart(networkCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: '带宽 (Mbps)',
              data: [],
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#e9ecef' }
              },
              x: {
                grid: { color: '#e9ecef' }
              }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });

        // 质量监控图表
        const qualityCtx = document.getElementById('qualityChart').getContext('2d');
        this.qualityChart = new Chart(qualityCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: '码率 (kbps)',
              data: [],
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#e9ecef' }
              },
              x: {
                grid: { color: '#e9ecef' }
              }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });
      }

      bindEvents() {
        this.elements.startBtn.addEventListener('click', () => this.startMonitoring());
        this.elements.stopBtn.addEventListener('click', () => this.stopMonitoring());
        this.elements.diagnosticBtn.addEventListener('click', () => this.runDiagnostics());
        this.elements.pauseLogBtn.addEventListener('click', () => this.toggleLogPause());
        this.elements.exportLogBtn.addEventListener('click', () => this.exportLog());
        this.elements.clearLogBtn.addEventListener('click', () => this.clearLog());
      }

      startMonitoring() {
        this.isMonitoring = true;
        this.startTime = Date.now();
        this.elements.startBtn.style.display = 'none';
        this.elements.stopBtn.style.display = 'inline-flex';

        this.log('success', '开始监控流媒体性能');
        this.updateMetrics();
        this.monitoringInterval = setInterval(() => this.updateMetrics(), 2000);
      }

      stopMonitoring() {
        this.isMonitoring = false;
        this.elements.startBtn.style.display = 'inline-flex';
        this.elements.stopBtn.style.display = 'none';

        if (this.monitoringInterval) {
          clearInterval(this.monitoringInterval);
        }

        this.log('info', '停止监控');
      }

      updateMetrics() {
        if (!this.isMonitoring) return;

        // 更新运行时间
        if (this.startTime) {
          const uptime = Math.floor((Date.now() - this.startTime) / 1000);
          this.elements.uptimeValue.textContent = this.formatUptime(uptime);
        }

        // 模拟网络指标
        const bandwidth = (Math.random() * 10 + 5).toFixed(1);
        const latency = Math.floor(Math.random() * 50 + 10);
        const packetLoss = (Math.random() * 2).toFixed(1);
        const jitter = Math.floor(Math.random() * 10 + 2);

        this.elements.bandwidthValue.textContent = bandwidth;
        this.elements.latencyValue.textContent = latency;
        this.elements.packetLoss.textContent = packetLoss + '%';
        this.elements.jitterValue.textContent = jitter;
        this.elements.throughput.textContent = (bandwidth * 0.8).toFixed(1) + 'M';

        // 模拟质量指标
        const bitrate = Math.floor(Math.random() * 1000 + 1500);
        const fps = Math.floor(Math.random() * 10 + 25);
        const droppedFrames = Math.floor(Math.random() * 5);

        this.elements.bitrateValue.textContent = bitrate;
        this.elements.fpsValue.textContent = fps;
        this.elements.resolutionValue.textContent = '1920x1080';
        this.elements.droppedFrames.textContent = droppedFrames;

        // 模拟系统资源
        const cpuUsage = Math.floor(Math.random() * 40 + 20);
        const memoryUsage = Math.floor(Math.random() * 30 + 40);

        this.elements.cpuUsage.textContent = cpuUsage + '%';
        this.elements.memoryUsage.textContent = memoryUsage + '%';
        this.elements.bufferLevel.textContent = Math.floor(Math.random() * 500 + 100) + 'ms';
        this.elements.networkSpeed.textContent = bandwidth + 'Mbps';

        this.elements.cpuPercent.textContent = cpuUsage + '%';
        this.elements.memoryPercent.textContent = memoryUsage + '%';
        this.elements.cpuProgress.style.width = cpuUsage + '%';
        this.elements.memoryProgress.style.width = memoryUsage + '%';

        // 更新健康评分
        const healthScore = Math.floor(100 - (latency / 10 + parseFloat(packetLoss) * 10 + cpuUsage / 2));
        this.elements.healthScore.textContent = Math.max(healthScore, 60);
        this.elements.activeConnections.textContent = Math.floor(Math.random() * 5 + 1);

        // 更新状态
        this.updateConnectionStatus(latency, packetLoss);
        this.updateNetworkStatus(bandwidth, packetLoss);
        this.updateQualityStatus(fps, droppedFrames);
        this.updateResourceStatus(cpuUsage, memoryUsage);

        // 更新图表
        this.updateCharts(bandwidth, bitrate);

        // 记录日志
        if (Math.random() < 0.3) { // 30% 概率记录日志
          const logTypes = ['info', 'warn'];
          const logType = logTypes[Math.floor(Math.random() * logTypes.length)];
          const messages = [
            `网络延迟: ${latency}ms`,
            `当前码率: ${bitrate}kbps`,
            `缓冲区状态良好`,
            `检测到轻微网络波动`,
            `流质量稳定`
          ];
          const message = messages[Math.floor(Math.random() * messages.length)];
          this.log(logType, message);
        }
      }

      updateConnectionStatus(latency, packetLoss) {
        if (latency < 30 && packetLoss < 1) {
          this.elements.connectionStatusBadge.textContent = '优秀';
          this.elements.connectionStatusBadge.className = 'card-status status-good';
          this.elements.connectionDot.className = 'status-dot dot-green';
          this.elements.connectionText.textContent = '连接状态优秀';
        } else if (latency < 60 && packetLoss < 3) {
          this.elements.connectionStatusBadge.textContent = '良好';
          this.elements.connectionStatusBadge.className = 'card-status status-warning';
          this.elements.connectionDot.className = 'status-dot dot-yellow';
          this.elements.connectionText.textContent = '连接状态良好';
        } else {
          this.elements.connectionStatusBadge.textContent = '较差';
          this.elements.connectionStatusBadge.className = 'card-status status-error';
          this.elements.connectionDot.className = 'status-dot dot-red';
          this.elements.connectionText.textContent = '连接质量较差';
        }

        this.elements.connectionDetails.textContent = `延迟: ${latency}ms | 丢包率: ${packetLoss}%`;
      }

      updateNetworkStatus(bandwidth, packetLoss) {
        if (bandwidth > 8 && packetLoss < 1) {
          this.elements.networkStatusBadge.textContent = '优秀';
          this.elements.networkStatusBadge.className = 'card-status status-good';
        } else if (bandwidth > 5 && packetLoss < 2) {
          this.elements.networkStatusBadge.textContent = '良好';
          this.elements.networkStatusBadge.className = 'card-status status-warning';
        } else {
          this.elements.networkStatusBadge.textContent = '较差';
          this.elements.networkStatusBadge.className = 'card-status status-error';
        }
      }

      updateQualityStatus(fps, droppedFrames) {
        if (fps >= 28 && droppedFrames < 2) {
          this.elements.qualityStatusBadge.textContent = '高清';
          this.elements.qualityStatusBadge.className = 'card-status status-good';
        } else if (fps >= 25 && droppedFrames < 5) {
          this.elements.qualityStatusBadge.textContent = '标清';
          this.elements.qualityStatusBadge.className = 'card-status status-warning';
        } else {
          this.elements.qualityStatusBadge.textContent = '较差';
          this.elements.qualityStatusBadge.className = 'card-status status-error';
        }
      }

      updateResourceStatus(cpu, memory) {
        if (cpu < 40 && memory < 60) {
          this.elements.resourceStatusBadge.textContent = '轻负载';
          this.elements.resourceStatusBadge.className = 'card-status status-good';
        } else if (cpu < 70 && memory < 80) {
          this.elements.resourceStatusBadge.textContent = '适中';
          this.elements.resourceStatusBadge.className = 'card-status status-warning';
        } else {
          this.elements.resourceStatusBadge.textContent = '高负载';
          this.elements.resourceStatusBadge.className = 'card-status status-error';
        }
      }

      updateCharts(bandwidth, bitrate) {
        const now = new Date().toLocaleTimeString();

        // 更新数据
        this.data.timestamps.push(now);
        this.data.network.push(parseFloat(bandwidth));
        this.data.quality.push(bitrate);

        // 限制数据点数量
        if (this.data.timestamps.length > this.maxDataPoints) {
          this.data.timestamps.shift();
          this.data.network.shift();
          this.data.quality.shift();
        }

        // 更新网络图表
        this.networkChart.data.labels = this.data.timestamps;
        this.networkChart.data.datasets[0].data = this.data.network;
        this.networkChart.update();

        // 更新质量图表
        this.qualityChart.data.labels = this.data.timestamps;
        this.qualityChart.data.datasets[0].data = this.data.quality;
        this.qualityChart.update();
      }

      async runDiagnostics() {
        this.elements.diagnosticSection.style.display = 'block';
        this.elements.diagnosticProgress.style.display = 'block';
        this.elements.diagnosticResults.innerHTML = '';

        this.log('info', '开始运行系统诊断...');

        const diagnostics = [
          { name: '网络连接测试', check: () => this.checkNetworkConnection() },
          { name: '服务器可达性', check: () => this.checkServerReachability() },
          { name: '浏览器兼容性', check: () => this.checkBrowserCompatibility() },
          { name: '解码器支持', check: () => this.checkCodecSupport() },
          { name: '带宽测试', check: () => this.checkBandwidth() },
          { name: '延迟测试', check: () => this.checkLatency() }
        ];

        for (let i = 0; i < diagnostics.length; i++) {
          const diagnostic = diagnostics[i];
          const progress = ((i + 1) / diagnostics.length) * 100;
          this.elements.diagnosticProgressBar.style.width = progress + '%';

          const result = await diagnostic.check();
          this.addDiagnosticResult(diagnostic.name, result);

          // 模拟诊断时间
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        this.elements.diagnosticProgress.style.display = 'none';
        this.log('success', '系统诊断完成');
      }

      async checkNetworkConnection() {
        try {
          const start = Date.now();
          await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' });
          const latency = Date.now() - start;
          return {
            status: latency < 100 ? 'pass' : 'warning',
            message: `网络连接正常 (${latency}ms)`,
            details: '可以正常访问外部网络'
          };
        } catch (error) {
          return {
            status: 'fail',
            message: '网络连接失败',
            details: '无法访问外部网络，请检查网络配置'
          };
        }
      }

      async checkServerReachability() {
        // 模拟服务器检查
        const isReachable = Math.random() > 0.1; // 90% 成功率
        return {
          status: isReachable ? 'pass' : 'fail',
          message: isReachable ? '流媒体服务器可达' : '流媒体服务器不可达',
          details: isReachable ? '服务器响应正常' : '请检查服务器状态和网络连接'
        };
      }

      checkBrowserCompatibility() {
        const isSupported = !!window.MediaSource;
        return {
          status: isSupported ? 'pass' : 'fail',
          message: isSupported ? '浏览器兼容性良好' : '浏览器不支持流媒体',
          details: isSupported ? '支持 MSE 和现代流媒体标准' : '请使用支持 HTML5 的现代浏览器'
        };
      }

      checkCodecSupport() {
        const video = document.createElement('video');
        const h264Support = video.canPlayType('video/mp4; codecs="avc1.42E01E"');
        return {
          status: h264Support ? 'pass' : 'warning',
          message: h264Support ? 'H.264 编码器支持' : '有限的编码器支持',
          details: h264Support ? '支持 H.264 视频编码' : '可能需要安装额外的编码器'
        };
      }

      async checkBandwidth() {
        // 模拟带宽测试
        const bandwidth = Math.random() * 10 + 5;
        return {
          status: bandwidth > 5 ? 'pass' : 'warning',
          message: `带宽: ${bandwidth.toFixed(1)} Mbps`,
          details: bandwidth > 5 ? '带宽充足，适合高清流媒体' : '带宽较低，可能影响播放质量'
        };
      }

      async checkLatency() {
        // 模拟延迟测试
        const latency = Math.floor(Math.random() * 100 + 20);
        return {
          status: latency < 50 ? 'pass' : latency < 100 ? 'warning' : 'fail',
          message: `网络延迟: ${latency}ms`,
          details: latency < 50 ? '延迟很低，实时性很好' :
            latency < 100 ? '延迟适中，可以接受' : '延迟较高，可能影响实时性'
        };
      }

      addDiagnosticResult(name, result) {
        const diagnosticItem = document.createElement('div');
        diagnosticItem.className = 'diagnostic-item';

        diagnosticItem.innerHTML = `
                    <div class="diagnostic-header">
                        <div class="diagnostic-title">${name}</div>
                        <div class="diagnostic-result result-${result.status}">
                            ${result.status === 'pass' ? '通过' :
            result.status === 'warning' ? '警告' : '失败'}
                        </div>
                    </div>
                    <div style="margin-bottom: 8px; font-weight: 600;">${result.message}</div>
                    <div class="diagnostic-details">${result.details}</div>
                `;

        this.elements.diagnosticResults.appendChild(diagnosticItem);
      }

      toggleLogPause() {
        this.isLogPaused = !this.isLogPaused;
        this.elements.pauseLogBtn.innerHTML = this.isLogPaused ?
          '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';

        this.log('info', this.isLogPaused ? '日志已暂停' : '日志已恢复');
      }

      exportLog() {
        const logEntries = Array.from(this.elements.logContent.children);
        const logText = logEntries.map(entry => entry.textContent).join('\n');

        const blob = new Blob([logText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `stream-monitor-log-${new Date().toISOString().split('T')[0]}.txt`;
        a.click();

        URL.revokeObjectURL(url);
        this.log('success', '日志已导出');
      }

      clearLog() {
        this.elements.logContent.innerHTML = '';
        this.log('info', '日志已清空');
      }

      log(level, message) {
        if (this.isLogPaused) return;

        const timestamp = new Date().toLocaleTimeString() + '.' +
          Date.now().toString().slice(-3);
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';

        logEntry.innerHTML = `
                    <span class="log-timestamp">${timestamp}</span>
                    <span class="log-level-${level}">[${level.toUpperCase()}]</span>
                    <span>${message}</span>
                `;

        this.elements.logContent.appendChild(logEntry);
        this.elements.logContent.scrollTop = this.elements.logContent.scrollHeight;

        // 限制日志条数
        const logEntries = this.elements.logContent.children;
        if (logEntries.length > 200) {
          this.elements.logContent.removeChild(logEntries[0]);
        }
      }

      formatUptime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        if (hours > 0) {
          return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
          return `${minutes}m ${secs}s`;
        } else {
          return `${secs}s`;
        }
      }
    }

    // 初始化监控系统
    document.addEventListener('DOMContentLoaded', () => {
      window.streamMonitor = new StreamMonitor();
    });
  </script>
</body>

</html>